<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Pool Chemistry Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --ios-blue: #007AFF;
            --ios-gray: #8E8E93;
            --ios-light-gray: #F2F2F7;
            --ios-separator: #C6C6C8;
            --ios-background: #FFFFFF;
            --ios-grouped-bg: #F2F2F7;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--ios-grouped-bg);
            color: #000;
            line-height: 1.47;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            min-height: 100vh;
        }

        .container {
            max-width: 640px;
            margin: 0 auto;
            padding: 20px 16px 60px;
        }

        header {
            text-align: center;
            margin-bottom: 28px;
            padding-top: 8px;
        }

        h1 {
            font-size: 34px;
            font-weight: 700;
            letter-spacing: -0.4px;
            margin-bottom: 4px;
        }

        .subtitle {
            color: var(--ios-gray);
            font-size: 15px;
            font-weight: 400;
        }

        .card {
            background: var(--ios-background);
            border-radius: 16px;
            padding: 0;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px 12px;
            border-bottom: 0.5px solid var(--ios-separator);
        }

        .card-title {
            font-size: 22px;
            font-weight: 600;
            letter-spacing: -0.3px;
            color: #000;
        }

        .card-body {
            padding: 16px 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 400;
            margin-bottom: 8px;
            color: var(--ios-gray);
            text-transform: uppercase;
            letter-spacing: -0.08px;
        }

        select, input[type="number"] {
            width: 100%;
            padding: 11px 16px;
            font-size: 17px;
            border: none;
            border-radius: 10px;
            background: var(--ios-light-gray);
            transition: all 0.2s ease;
            -webkit-appearance: none;
            appearance: none;
            font-family: inherit;
            color: #000;
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg width='14' height='8' viewBox='0 0 14 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L7 7L13 1' stroke='%23C7C7CC' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 44px;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
            font-variant-numeric: tabular-nums;
        }

        select:focus, input:focus {
            outline: none;
            background: #E8E8ED;
        }

        .hidden {
            display: none !important;
        }

        .reference-list {
            padding: 0;
        }

        .reference-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 0.5px solid var(--ios-separator);
        }

        .reference-item:last-child {
            border-bottom: none;
        }

        .reference-label {
            font-size: 17px;
            color: #000;
            font-weight: 400;
        }

        .reference-value {
            font-size: 17px;
            color: var(--ios-gray);
            font-weight: 400;
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .calculation-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            padding: 16px 20px;
        }

        .calc-button {
            padding: 14px 12px;
            background: var(--ios-light-gray);
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            color: #000;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: center;
            -webkit-tap-highlight-color: transparent;
        }

        .calc-button:active {
            transform: scale(0.96);
            background: #E8E8ED;
        }

        .calc-button.active {
            background: var(--ios-blue);
            color: white;
        }

        .toggle-group {
            display: flex;
            background: var(--ios-light-gray);
            border-radius: 9px;
            padding: 2px;
            margin-bottom: 12px;
        }

        .toggle-option {
            flex: 1;
            padding: 7px 12px;
            background: transparent;
            border: none;
            border-radius: 7px;
            font-size: 13px;
            font-weight: 600;
            color: #000;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-tap-highlight-color: transparent;
        }

        .toggle-option.active {
            background: var(--ios-background);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12), 0 1px 1px rgba(0, 0, 0, 0.04);
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .result-card {
            background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%);
            border-radius: 16px;
            color: white;
            text-align: center;
            margin: 0 20px;
            transform: scale(0.95);
            opacity: 0;
            max-height: 0;
            padding: 0 24px;
            overflow: hidden;
            transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .result-card.show {
            transform: scale(1);
            opacity: 1;
            max-height: 200px;
            padding: 32px 24px;
            margin: 20px 20px 16px;
        }

        .result-label {
            font-size: 15px;
            opacity: 0.85;
            margin-bottom: 12px;
            font-weight: 500;
            letter-spacing: -0.2px;
        }

        .result-value {
            font-size: 56px;
            font-weight: 700;
            letter-spacing: -2px;
            line-height: 1;
            margin-bottom: 8px;
            font-variant-numeric: tabular-nums;
        }

        .result-unit {
            font-size: 22px;
            opacity: 0.9;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .result-chemical {
            font-size: 17px;
            opacity: 0.8;
            margin-top: 16px;
            font-weight: 400;
            letter-spacing: -0.2px;
        }

        .result-card.mismatch {
            background: linear-gradient(135deg, #FF9500 0%, #FF6B00 100%);
        }

        .result-card.mismatch .result-value {
            font-size: 20px;
            letter-spacing: -0.3px;
            line-height: 1.4;
        }

        .result-card.mismatch .result-unit {
            display: none;
        }

        /* Chemical-specific colors */
        .result-card.chem-bicarb {
            background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%);
        }
        .result-card.chem-hypo {
            background: linear-gradient(135deg, #34C759 0%, #248A3D 100%);
        }
        .result-card.chem-cya {
            background: linear-gradient(135deg, #AF52DE 0%, #8944AB 100%);
        }
        .result-card.chem-hcl {
            background: linear-gradient(135deg, #FF3B30 0%, #C41E3A 100%);
        }
        .result-card.chem-thio {
            background: linear-gradient(135deg, #FFCC00 0%, #E6A800 100%);
        }
        .result-card.chem-thio .result-label,
        .result-card.chem-thio .result-value,
        .result-card.chem-thio .result-unit,
        .result-card.chem-thio .result-chemical {
            color: #1a1a1a;
        }

        /* Legend styles */
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            padding: 16px 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--ios-light-gray);
            border-radius: 8px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .legend-color.bicarb { background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%); }
        .legend-color.hypo { background: linear-gradient(135deg, #34C759 0%, #248A3D 100%); }
        .legend-color.cya { background: linear-gradient(135deg, #AF52DE 0%, #8944AB 100%); }
        .legend-color.hcl { background: linear-gradient(135deg, #FF3B30 0%, #C41E3A 100%); }
        .legend-color.thio { background: linear-gradient(135deg, #FFCC00 0%, #E6A800 100%); }

        .legend-name {
            font-size: 13px;
            color: #000;
            font-weight: 400;
            line-height: 1.2;
        }

        @media (max-width: 480px) {
            .legend-grid {
                grid-template-columns: 1fr;
            }
        }

        .pool-volume-display {
            display: block;
            margin-top: 8px;
            font-size: 15px;
            color: var(--ios-gray);
            font-weight: 400;
        }

        .info-badge {
            display: inline-block;
            background: rgba(0, 122, 255, 0.1);
            color: var(--ios-blue);
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @media (max-width: 480px) {
            .calculation-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 28px;
            }

            .result-value {
                font-size: 48px;
            }
        }

        @media (min-width: 768px) {
            .container {
                padding-top: 40px;
            }

            h1 {
                font-size: 40px;
            }

            .card {
                margin-bottom: 20px;
            }
        }

        @media (hover: hover) {
            .calc-button:hover {
                background: #E8E8ED;
            }

            .calc-button.active:hover {
                background: #0066FF;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Pool Chemistry</h1>
            <p class="subtitle">Calculate chemical dosages</p>
        </header>

        <!-- Pool Selection -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Select Pool</h2>
            </div>
            <div class="card-body">
                <div class="toggle-group">
                    <button class="toggle-option active" data-facility="pelican">Pelican Park</button>
                    <button class="toggle-option" data-facility="cribpoint">Crib Point</button>
                </div>
            </div>

            <div class="calculation-grid" id="pelicanPools" style="padding: 0 20px 16px;">
                <button class="calc-button active" data-pool="660000">Main Pool</button>
                <button class="calc-button" data-pool="76000">Leisure Pool</button>
                <button class="calc-button" data-pool="12000">Spa</button>
                <button class="calc-button" data-pool="custom">Custom</button>
            </div>

            <div class="calculation-grid hidden" id="cribpointPools" style="padding: 0 20px 16px;">
                <button class="calc-button" data-pool="440000">Main Pool</button>
                <button class="calc-button" data-pool="15000">Leisure Pool</button>
                <button class="calc-button" data-pool="custom">Custom</button>
            </div>

            <div class="card-body" style="padding-top: 0;">
                <span class="pool-volume-display" id="poolVolume" style="display: block; text-align: center;">660,000 L</span>

                <div class="form-group hidden" id="customVolumeGroup" style="margin-top: 16px;">
                    <label for="customVolume">Custom Volume (L)</label>
                    <input type="number" id="customVolume" placeholder="Enter volume in liters" min="0" step="1000">
                </div>
            </div>
        </div>

        <!-- Chemical Calculator -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Calculate Adjustment</h2>
            </div>
            <div class="card-body">
                <div class="toggle-group">
                    <button class="toggle-option active" data-direction="increase">Increase</button>
                    <button class="toggle-option" data-direction="decrease">Decrease</button>
                </div>
            </div>

            <div class="calculation-grid" id="increaseOptions">
                <button class="calc-button" data-calc="alkalinity-up">Alkalinity</button>
                <button class="calc-button" data-calc="chlorine-up">Free Chlorine</button>
                <button class="calc-button" data-calc="ph-up">pH</button>
                <button class="calc-button hidden" data-calc="cya-up" id="cyaButton">CYA</button>
            </div>

            <div class="calculation-grid hidden" id="decreaseOptions">
                <button class="calc-button" data-calc="alkalinity-down">Alkalinity</button>
                <button class="calc-button" data-calc="chlorine-down">Free Chlorine</button>
                <button class="calc-button" data-calc="ph-down">pH</button>
            </div>

            <div id="calculatorInputs" class="hidden">
                <div id="chemicalOptions" class="hidden" style="padding: 0 20px 16px;"></div>

                <div class="card-body">
                    <div class="input-row">
                        <div class="form-group">
                            <label for="currentValue">Current (mg/L)</label>
                            <input type="number" id="currentValue" placeholder="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="targetValue">Target (mg/L)</label>
                            <input type="number" id="targetValue" placeholder="0" step="0.1">
                        </div>
                    </div>
                </div>
            </div>

            <div id="result" class="result-card">
                <div class="result-label">Add</div>
                <div>
                    <span class="result-value" id="resultValue">0</span>
                    <span class="result-unit" id="resultUnit">kg</span>
                </div>
                <div class="result-chemical" id="resultChemical">Sodium Bicarbonate</div>
            </div>
        </div>

        <!-- Chemical Legend -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Chemical Legend</h2>
            </div>
            <div class="legend-grid">
                <div class="legend-item">
                    <div class="legend-color bicarb"></div>
                    <span class="legend-name">Sodium Bicarbonate</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color hypo"></div>
                    <span class="legend-name">Sodium Hypochlorite 12.5%</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color cya"></div>
                    <span class="legend-name">Isocyanuric Acid</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color hcl"></div>
                    <span class="legend-name">HCl 33%</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color thio"></div>
                    <span class="legend-name">Sodium Thiosulphate</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let state = {
            poolVolume: 660000,
            poolType: 'pelican',
            selectedCalc: null,
            selectedChemical: null,
            direction: 'increase',
            currentValue: 0,
            targetValue: 0,
            inputMemory: {} // Stores {calcBaseName: {current: value, target: value}}
        };

        // Pool configurations
        const pools = {
            '660000': { type: 'pelican', name: 'Main Pool - Pelican Park', chlorineRange: '1-2.5 mg/L' },
            '76000': { type: 'pelican', name: 'Leisure Pool - Pelican Park', chlorineRange: '1-2.5 mg/L' },
            '12000': { type: 'pelican', name: 'Spa - Pelican Park', chlorineRange: '3-4.5 mg/L' },
            '440000': { type: 'cribpoint', name: 'Main Pool - Crib Point', chlorineRange: '2-3.5 mg/L' },
            '15000': { type: 'cribpoint', name: 'Leisure Pool - Crib Point', chlorineRange: '2-3.5 mg/L' }
        };

        // Target ranges for each calculation type
        const targetRanges = {
            'alkalinity': '80-120 mg/L',
            'ph': '7.35',
            'chlorine': null, // Dynamic - uses pool's chlorineRange
            'cya': '30-100 mg/L',
            'calcium': '200-400 mg/L'
        };

        // Chemical to color class mapping
        const chemicalColors = {
            'Sodium Bicarbonate': 'chem-bicarb',
            'Sodium Hypochlorite 12.5%': 'chem-hypo',
            'Isocyanuric Acid': 'chem-cya',
            'HCl 33%': 'chem-hcl',
            'Sodium Thiosulphate': 'chem-thio'
        };

        // Chemical calculations
        const calculations = {
            'alkalinity-up': {
                label: 'Increase Alkalinity',
                chemical: 'Sodium Bicarbonate',
                multiplier: 2,
                unit: 'kg'
            },
            'chlorine-up': {
                label: 'Increase Free Chlorine',
                chemical: 'Sodium Hypochlorite 12.5%',
                multiplier: 8,
                unit: 'L'
            },
            'cya-up': {
                label: 'Increase CYA',
                chemical: 'Isocyanuric Acid',
                multiplier: 1,
                unit: 'kg'
            },
            'ph-up': {
                label: 'Increase pH',
                chemical: 'Sodium Bicarbonate',
                multiplier: 800,
                unit: 'kg'
            },
            'alkalinity-down': {
                label: 'Decrease Alkalinity',
                chemical: 'HCl 33%',
                multiplier: 2,
                unit: 'L'
            },
            'chlorine-down': {
                label: 'Decrease Free Chlorine',
                chemical: 'Sodium Thiosulphate',
                multiplier: 1,
                unit: 'kg'
            },
            'ph-down': {
                label: 'Decrease pH',
                chemical: 'HCl 33%',
                multiplier: 0.833,
                unit: 'L'
            }
        };

        // DOM elements
        const facilityButtons = document.querySelectorAll('[data-facility]');
        const pelicanPools = document.getElementById('pelicanPools');
        const cribpointPools = document.getElementById('cribpointPools');
        const customVolumeGroup = document.getElementById('customVolumeGroup');
        const customVolume = document.getElementById('customVolume');
        const poolVolume = document.getElementById('poolVolume');
        const cyaButton = document.getElementById('cyaButton');
        const directionToggleButtons = document.querySelectorAll('[data-direction]');
        const increaseOptions = document.getElementById('increaseOptions');
        const decreaseOptions = document.getElementById('decreaseOptions');
        const calcButtons = document.querySelectorAll('[data-calc]');
        const calculatorInputs = document.getElementById('calculatorInputs');
        const chemicalOptions = document.getElementById('chemicalOptions');
        const currentValue = document.getElementById('currentValue');
        const targetValue = document.getElementById('targetValue');
        const result = document.getElementById('result');
        const resultValue = document.getElementById('resultValue');
        const resultUnit = document.getElementById('resultUnit');
        const resultChemical = document.getElementById('resultChemical');

        // Event listeners
        facilityButtons.forEach(btn => btn.addEventListener('click', handleFacilityToggle));
        customVolume.addEventListener('input', handleCustomVolumeChange);
        directionToggleButtons.forEach(btn => btn.addEventListener('click', handleDirectionToggle));
        calcButtons.forEach(btn => btn.addEventListener('click', handleCalcSelection));
        currentValue.addEventListener('input', handleInputChange);
        targetValue.addEventListener('input', handleInputChange);

        function handleInputChange() {
            // Save to memory for current calculation
            if (state.selectedCalc) {
                const baseName = state.selectedCalc.replace(/-up$|-down$/, '');
                state.inputMemory[baseName] = {
                    current: currentValue.value,
                    target: targetValue.value
                };
            }
            calculate();
        }

        // Add pool button event listeners dynamically
        function attachPoolListeners() {
            document.querySelectorAll('[data-pool]').forEach(btn => {
                btn.addEventListener('click', handlePoolClick);
            });
        }
        attachPoolListeners();

        function handleFacilityToggle(e) {
            const facility = e.target.dataset.facility;

            // Update facility toggle active states
            facilityButtons.forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');

            // Show/hide appropriate pool options
            if (facility === 'pelican') {
                pelicanPools.classList.remove('hidden');
                cribpointPools.classList.add('hidden');
                state.poolType = 'pelican';
                cyaButton.classList.add('hidden');
            } else {
                pelicanPools.classList.add('hidden');
                cribpointPools.classList.remove('hidden');
                state.poolType = 'cribpoint';
                cyaButton.classList.remove('hidden');
            }

            // Click the first pool button in the visible set
            const visiblePools = facility === 'pelican' ? pelicanPools : cribpointPools;
            const firstPoolButton = visiblePools.querySelector('[data-pool]:not([data-pool="custom"])');
            if (firstPoolButton) {
                firstPoolButton.click();
            }
        }

        function handlePoolClick(e) {
            const value = e.target.dataset.pool;
            const parentGrid = e.target.closest('.calculation-grid');

            // Update button active states within the same grid
            parentGrid.querySelectorAll('[data-pool]').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');

            if (value === 'custom') {
                customVolumeGroup.classList.remove('hidden');
                poolVolume.style.display = 'none';
                state.poolType = 'custom';
            } else {
                customVolumeGroup.classList.add('hidden');
                poolVolume.style.display = 'block';
                state.poolVolume = parseInt(value);
                state.poolType = pools[value].type;
                poolVolume.textContent = formatNumber(state.poolVolume) + ' L';

                // Show/hide CYA option for Crib Point pools
                if (state.poolType === 'cribpoint') {
                    cyaButton.classList.remove('hidden');
                } else {
                    cyaButton.classList.add('hidden');
                }
            }

            calculate();
        }

        function handleCustomVolumeChange(e) {
            const value = parseInt(e.target.value) || 0;
            state.poolVolume = value;
            calculate();
        }

        function handleDirectionToggle(e) {
            const direction = e.target.dataset.direction;
            const previousCalc = state.selectedCalc;
            state.direction = direction;

            // Update active toggle
            directionToggleButtons.forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');

            // Show/hide option sets
            if (direction === 'increase') {
                increaseOptions.classList.remove('hidden');
                decreaseOptions.classList.add('hidden');
            } else {
                increaseOptions.classList.add('hidden');
                decreaseOptions.classList.remove('hidden');
            }

            // Try to preserve selection if equivalent exists in new direction
            if (previousCalc) {
                const baseName = previousCalc.replace(/-up$|-down$/, '');
                const newCalc = baseName + (direction === 'increase' ? '-up' : '-down');
                const newButton = document.querySelector(`[data-calc="${newCalc}"]`);

                if (newButton && !newButton.classList.contains('hidden')) {
                    newButton.click();
                    return;
                }
            }

            // Reset if no equivalent found
            resetCalculator();
        }

        function handleCalcSelection(e) {
            const calcType = e.target.dataset.calc;
            const previousCalc = state.selectedCalc;
            state.selectedCalc = calcType;

            // Update active button
            calcButtons.forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');

            // Show inputs
            calculatorInputs.classList.remove('hidden');

            // Handle input values - restore from memory or clear
            const previousBase = previousCalc ? previousCalc.replace(/-up$|-down$/, '') : null;
            const currentBase = calcType.replace(/-up$|-down$/, '');
            if (previousBase !== currentBase) {
                // Check if we have saved values for this calculation type
                const savedValues = state.inputMemory[currentBase];
                if (savedValues) {
                    currentValue.value = savedValues.current;
                    targetValue.value = savedValues.target;
                } else {
                    currentValue.value = '';
                    targetValue.value = '';
                }
                result.classList.remove('show', 'mismatch');
            }

            // Update input labels based on calculation type
            const baseName = calcType.replace(/-up$|-down$/, '');
            const isPH = baseName === 'ph';

            // Get target range for this calculation type
            let range = targetRanges[baseName];
            if (baseName === 'chlorine') {
                // Use pool-specific chlorine range
                const poolConfig = pools[state.poolVolume];
                range = poolConfig ? poolConfig.chlorineRange : '1-2.5 mg/L';
            }

            document.querySelector('label[for="currentValue"]').textContent = isPH ? 'Current' : 'Current (mg/L)';
            document.querySelector('label[for="targetValue"]').textContent = isPH ? `Target (${range})` : `Target (${range})`;

            // Handle chemical options
            const calc = calculations[calcType];
            if (calc.options) {
                showChemicalOptions(calc.options);
            } else {
                chemicalOptions.classList.add('hidden');
                state.selectedChemical = {
                    chemical: calc.chemical,
                    multiplier: calc.multiplier,
                    unit: calc.unit
                };
            }

            calculate();
        }

        function showChemicalOptions(options) {
            chemicalOptions.classList.remove('hidden');
            chemicalOptions.innerHTML = '<div class="toggle-group" id="chemicalToggle"></div>';

            const toggleGroup = chemicalOptions.querySelector('#chemicalToggle');
            options.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'toggle-option' + (index === 0 ? ' active' : '');
                btn.textContent = option.chemical;
                btn.dataset.index = index;
                btn.addEventListener('click', (e) => {
                    toggleGroup.querySelectorAll('.toggle-option').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    state.selectedChemical = option;
                    calculate();
                });
                toggleGroup.appendChild(btn);
            });

            state.selectedChemical = options[0];
        }

        function calculate() {
            if (!state.selectedCalc || !state.selectedChemical) {
                result.classList.remove('show', 'mismatch');
                return;
            }

            const current = parseFloat(currentValue.value) || 0;
            const target = parseFloat(targetValue.value) || 0;

            if (current === 0 && target === 0) {
                result.classList.remove('show', 'mismatch');
                return;
            }

            // Check if direction matches the values
            const baseName = state.selectedCalc.replace(/-up$|-down$/, '');
            const paramName = baseName === 'ph' ? 'pH' :
                             baseName === 'cya' ? 'CYA' :
                             baseName.charAt(0).toUpperCase() + baseName.slice(1);

            if (state.direction === 'increase' && target <= current) {
                showMismatchMessage(`Target ${paramName} must be higher than current to increase`);
                return;
            }
            if (state.direction === 'decrease' && current <= target) {
                showMismatchMessage(`Current ${paramName} must be higher than target to decrease`);
                return;
            }

            // Formula: (|target - current| / 1,000,000) × poolVolume × multiplier
            const diff = Math.abs(target - current);
            const amount = (diff / 1000000) * state.poolVolume * state.selectedChemical.multiplier;

            if (amount <= 0) {
                result.classList.remove('show', 'mismatch');
                return;
            }

            // Display result
            result.classList.remove('mismatch');
            clearChemicalColors();
            const colorClass = chemicalColors[state.selectedChemical.chemical];
            if (colorClass) {
                result.classList.add(colorClass);
            }
            resultValue.textContent = amount.toFixed(2);
            resultUnit.textContent = state.selectedChemical.unit;
            resultChemical.textContent = state.selectedChemical.chemical;
            result.classList.add('show');
        }

        function clearChemicalColors() {
            Object.values(chemicalColors).forEach(cls => result.classList.remove(cls));
        }

        function showMismatchMessage(message) {
            clearChemicalColors();
            result.classList.add('mismatch', 'show');
            resultValue.textContent = message;
            resultUnit.textContent = '';
            resultChemical.textContent = '';
        }

        function resetCalculator() {
            state.selectedCalc = null;
            state.selectedChemical = null;
            calcButtons.forEach(btn => btn.classList.remove('active'));
            calculatorInputs.classList.add('hidden');
            clearChemicalColors();
            result.classList.remove('show', 'mismatch');
            currentValue.value = '';
            targetValue.value = '';
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
    </script>
</body>
</html>